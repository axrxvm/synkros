<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Direct Share - Synkros</title>
    <meta name="description" content="Share files directly with end-to-end encryption" />
    <link rel="apple-touch-icon" href="/apple-icon.png" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="stylesheet" href="/css/style.min.css" />
  </head>
  <body data-ray-id="<%= rayId %>">
    <style>
      * { box-sizing: border-box; }
      html, body { 
        margin: 0; 
        padding: 0;
        min-height: 100vh;
      }
      body { 
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
      }
      
      .page-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .footer {
        margin-top: auto;
      }

      /* Setup Screen */
      .setup-screen {
        min-height: 100vh;
        padding: 80px 20px 100px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .setup-card {
        background: var(--card-color);
        border: 1px solid var(--light-border-color);
        border-radius: 12px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
      }

      .setup-card h2 {
        margin: 0 0 10px;
        color: var(--text-color);
        font-size: 1.75rem;
        font-weight: 600;
      }

      .setup-card > p {
        color: var(--text-color-muted);
        margin: 0 0 30px;
        line-height: 1.6;
      }

      .form-section {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--light-border-color);
      }

      .form-section:last-of-type {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .form-section h3 {
        margin: 0 0 16px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
      }

      .form-group {
        margin-bottom: 16px;
        position: relative;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-color);
        font-weight: 500;
        font-size: 14px;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .form-group input[type="text"],
      .form-group input[type="password"],
      .form-group input[type="number"] {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-color);
        border: 1px solid var(--light-border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .input-wrapper input {
        padding-right: 45px;
      }

      .toggle-visibility {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        color: var(--text-color-muted);
        font-size: 18px;
        line-height: 1;
        transition: color 0.2s;
        user-select: none;
      }

      .toggle-visibility:hover {
        color: var(--text-color);
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--app-color);
        background: var(--card-color);
      }

      .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 12px;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .radio-option input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .radio-option label {
        margin: 0;
        cursor: pointer;
        color: var(--text-color);
        font-weight: 500;
      }

      .btn {
        width: 100%;
        padding: 14px 24px;
        background: var(--app-color);
        border: none;
        border-radius: 8px;
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
        margin-top: 24px;
      }

      .btn:hover {
        background: var(--app-color-hover);
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Dashboard */
      .dashboard {
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 50px);
        padding-top: 60px;
        padding-bottom: 60px;
      }

      .dash-header {
        background: var(--card-color);
        border-bottom: 1px solid var(--light-border-color);
        padding: 20px 30px;
      }

      .dash-header-inner {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        flex-wrap: wrap;
      }

      .dash-info {
        display: flex;
        align-items: center;
        gap: 24px;
        flex: 1;
      }

      .room-badge {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .room-label {
        color: var(--text-color-muted);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .room-code {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--app-color);
        letter-spacing: 0.15rem;
        font-family: 'Courier New', monospace;
      }

      .peers-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        background: rgba(76, 175, 80, 0.1);
        border-radius: 20px;
        border: 1px solid rgba(76, 175, 80, 0.3);
      }

      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #4caf50;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; box-shadow: 0 0 4px #4caf50; }
        50% { opacity: 0.6; }
      }

      .peers-text {
        color: #4caf50;
        font-size: 13px;
        font-weight: 600;
      }

      .dash-actions {
        display: flex;
        gap: 10px;
      }

      .btn-sm {
        padding: 9px 18px;
        font-size: 14px;
        width: auto;
        margin: 0;
      }

      .btn-secondary {
        background: var(--btn-bg-color);
        color: var(--text-color);
      }

      .btn-secondary:hover {
        background: var(--light-border-color);
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .dash-grid {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      .dash-panel {
        padding: 30px;
        border-right: 1px solid var(--light-border-color);
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 160px);
      }

      .dash-panel:last-child {
        border-right: none;
      }

      .panel-head {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
        padding-bottom: 14px;
        border-bottom: 1px solid var(--light-border-color);
      }

      .panel-icon {
        font-size: 20px;
      }

      .panel-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
      }

      .panel-body {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* Upload Zone */
      .upload-zone {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: rgba(76, 139, 244, 0.03);
        padding: 60px 40px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        min-height: 300px;
      }

      .upload-zone::before {
        content: '';
        position: absolute;
        inset: 0;
        border: 2px dashed transparent;
        border-radius: 12px;
        transition: all 0.3s;
      }

      .upload-zone:hover::before,
      .upload-zone.drag-over::before {
        border-color: var(--app-color);
      }

      .upload-zone:hover {
        background: rgba(76, 139, 244, 0.08);
        transform: translateY(-2px);
      }

      .upload-zone.drag-over {
        background: rgba(76, 139, 244, 0.12);
        transform: scale(1.01);
      }

      .upload-icon {
        width: 64px;
        height: 64px;
        margin-bottom: 20px;
        opacity: 0.7;
        transition: all 0.3s;
      }

      .upload-zone:hover .upload-icon {
        opacity: 1;
        transform: scale(1.05);
      }

      .upload-title {
        color: var(--text-color);
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .upload-subtitle {
        color: var(--text-color-muted);
        font-size: 13px;
      }

      /* Progress */
      .upload-progress {
        margin-top: 20px;
        padding: 16px;
        background: var(--card-color);
        border-radius: 8px;
        border: 1px solid var(--light-border-color);
      }

      .send-progress-overlay {
        position: absolute;
        inset: 0;
        background: var(--card-color);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 30px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .send-progress-overlay:not(.hidden) {
        opacity: 1;
        pointer-events: auto;
      }

      .upload-zone.sending .upload-icon,
      .upload-zone.sending .upload-title,
      .upload-zone.sending .upload-subtitle {
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .progress-bar-wrap {
        width: 100%;
        height: 6px;
        background: var(--progressbar-bg-color);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--app-color), #5c9eff);
        transition: width 0.3s;
        width: 0%;
      }

      .progress-label {
        font-size: 13px;
        color: var(--text-color-muted);
        text-align: center;
      }

      /* Files List */
      .files-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: var(--text-color-muted);
        min-height: 300px;
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      .empty-text {
        font-size: 14px;
      }

      .files-list {
        flex: 1;
        overflow-y: auto;
      }

      .file-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        background: var(--card-color);
        border: 1px solid var(--light-border-color);
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.2s;
      }

      .file-item:hover {
        background: rgba(76, 139, 244, 0.05);
        border-color: var(--app-color);
        transform: translateX(4px);
      }

      .file-icon {
        font-size: 28px;
      }

      .file-info {
        flex: 1;
        min-width: 0;
      }

      .file-name {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .file-size {
        font-size: 12px;
        color: var(--text-color-muted);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        min-width: 300px;
        max-width: 400px;
        padding: 16px 20px;
        background: var(--card-color);
        border: 1px solid var(--light-border-color);
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: none;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .toast.success {
        background: #4caf50;
        border-color: #388e3c;
        color: white;
      }

      .toast.error {
        background: #dc3545;
        border-color: #c82333;
        color: white;
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }

      .modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background: var(--card-color);
        border: 1px solid var(--light-border-color);
        border-radius: 12px;
        padding: 30px;
        max-width: 480px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s;
      }

      .modal.active .modal-content {
        transform: scale(1);
      }

      .modal-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: var(--text-color-muted);
        cursor: pointer;
        padding: 0;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: var(--bg-color);
        color: var(--text-color);
      }

      .share-url {
        background: var(--bg-color);
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        border: 1px solid var(--light-border-color);
      }

      .share-url-label {
        color: var(--text-color-muted);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: block;
      }

      .share-url-value {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        color: var(--text-color);
        word-break: break-all;
        line-height: 1.5;
      }

      .qr-code {
        text-align: center;
        margin-bottom: 24px;
      }

      .qr-code #qr-canvas {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        background: white;
        padding: 16px;
        border-radius: 8px;
      }
      
      .qr-code #qr-canvas img {
        display: block;
        max-width: 100%;
        height: auto;
      }

      .hidden {
        display: none !important;
      }

      /* Responsive */
      @media (max-width: 968px) {
        .dash-grid {
          grid-template-columns: 1fr;
        }

        .dash-panel {
          border-right: none;
          border-bottom: 1px solid var(--light-border-color);
          min-height: 500px;
        }

        .dash-panel:last-child {
          border-bottom: none;
        }

        .dash-info {
          width: 100%;
          justify-content: space-between;
        }

        .dash-actions {
          width: 100%;
        }

        .dash-actions .btn-sm {
          flex: 1;
        }
      }

      @media (max-width: 640px) {
        .setup-card {
          padding: 30px 24px;
        }

        .dash-header {
          padding: 16px 20px;
        }

        .room-code {
          font-size: 1.2rem;
          letter-spacing: 0.1rem;
        }

        .dashboard {
          padding-bottom: 60px;
        }

        .dash-panel {
          padding: 20px;
          min-height: auto;
        }

        .upload-zone {
          padding: 40px 20px;
        }

        .toast {
          bottom: 20px;
          right: 20px;
          left: 20px;
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
    <nav class="navbar">
      <div class="navbar-container">
        <a href="#" class="navbar-logo" id="logoBtn">Synkros</a>
        <div class="navbar-links">
          <a href="/" class="nav-link">Upload</a>
          <a href="/direct" class="nav-link">Direct</a>
          <a href="/privacy" class="nav-link">Privacy</a>
        </div>
      </div>
    </nav>

    <!-- Setup Screen -->
    <div id="setup-screen" class="setup-screen">
      <div class="setup-card">
        <h2>üîó Direct File Sharing</h2>
        <p>Share files directly with others using encrypted peer-to-peer connections. No server storage, unlimited file sizes.</p>

        <div class="form-section">
          <h3>Connection Mode</h3>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="mode-create" name="mode" value="create" checked />
              <label for="mode-create">Create Room</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="mode-join" name="mode" value="join" />
              <label for="mode-join">Join Room</label>
            </div>
          </div>
        </div>

        <div id="create-section" class="form-section">
          <h3>Room Settings</h3>
          <div class="form-group">
            <label for="max-peers">Maximum Peers (2-10)</label>
            <input type="number" id="max-peers" min="2" max="10" value="2" autocomplete="off" />
          </div>
          <div class="form-group">
            <label for="room-password">Password (Optional)</label>
            <div class="input-wrapper">
              <input type="password" id="room-password" placeholder="Leave blank for no password" autocomplete="new-password" />
              <button type="button" class="toggle-visibility" data-target="room-password" title="Toggle visibility">üëÅÔ∏è</button>
            </div>
          </div>
        </div>

        <div id="join-section" class="form-section hidden">
          <h3>Join Details</h3>
          <p style="margin: 0 0 16px; color: var(--text-color-muted); font-size: 14px; line-height: 1.5;">
            üîë For security, you need the <strong>encryption key</strong> from the share URL. Paste the full share link below or enter details manually.
          </p>
          <div class="form-group">
            <label for="join-url">Share URL (Paste Here)</label>
            <input type="text" id="join-url" placeholder="Paste full share URL (e.g., https://.../#ROOMCODE:KEY)" autocomplete="off" />
          </div>
          <div style="text-align: center; margin: 10px 0; color: var(--text-color-muted); font-size: 13px;">‚Äî OR ‚Äî</div>
          <div class="form-group">
            <label for="join-code">Room Code</label>
            <input type="text" id="join-code" placeholder="8-character room code" maxlength="8" style="text-transform: uppercase;" autocomplete="off" />
          </div>
          <div class="form-group">
            <label for="join-key">Encryption Key <span style="color: #f44336;">*</span></label>
            <div class="input-wrapper">
              <input type="password" id="join-key" placeholder="64-character hex encryption key" maxlength="64" autocomplete="off" />
              <button type="button" class="toggle-visibility" data-target="join-key" title="Toggle visibility">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="form-group">
            <label for="join-password">Password (if required)</label>
            <div class="input-wrapper">
              <input type="password" id="join-password" placeholder="Room password" autocomplete="new-password" />
              <button type="button" class="toggle-visibility" data-target="join-password" title="Toggle visibility">üëÅÔ∏è</button>
            </div>
          </div>
        </div>

        <button id="connect-btn" class="btn">Create Room</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
      <div class="dash-header">
        <div class="dash-header-inner">
          <div class="dash-info">
            <div class="room-badge">
              <span class="room-label">Room Code</span>
              <span id="room-code-display" class="room-code">------</span>
            </div>
            <div class="peers-badge">
              <span class="status-dot"></span>
              <span id="peer-count" class="peers-text">0 peers</span>
            </div>
          </div>
          <div class="dash-actions">
            <button id="share-btn" class="btn btn-secondary btn-sm">üì§ Share</button>
            <button id="leave-btn" class="btn btn-danger btn-sm">üö™ Leave</button>
          </div>
        </div>
      </div>

      <div class="dash-grid">
        <!-- Send Panel -->
        <div class="dash-panel">
          <div class="panel-head">
            <span class="panel-icon">üì§</span>
            <h3 class="panel-title">Send Files</h3>
          </div>
          <div class="panel-body">
            <div id="upload-zone" class="upload-zone">
              <img src="/img/file.png" alt="Upload" class="upload-icon" />
              <div class="upload-title">Drop files here or click to select</div>
              <div class="upload-subtitle">Files are sent directly to connected peers</div>
              <div id="send-progress" class="send-progress-overlay hidden">
                <div class="progress-bar-wrap">
                  <div id="send-progress-bar" class="progress-bar-fill"></div>
                </div>
                <div id="send-progress-label" class="progress-label">Sending...</div>
              </div>
            </div>
            <input type="file" id="file-input" multiple style="display: none;" />
          </div>
        </div>

        <!-- Receive Panel -->
        <div class="dash-panel">
          <div class="panel-head">
            <span class="panel-icon">üì•</span>
            <h3 class="panel-title">Received Files</h3>
          </div>
          <div class="panel-body">
            <div id="receive-progress" class="upload-progress hidden">
              <div class="progress-bar-wrap">
                <div id="receive-progress-bar" class="progress-bar-fill"></div>
              </div>
              <div id="receive-progress-label" class="progress-label">Receiving...</div>
            </div>
            <div id="files-empty" class="files-empty">
              <div class="empty-icon">üì≠</div>
              <div class="empty-text">No files received yet</div>
            </div>
            <div id="files-list" class="files-list hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
      <div class="modal-content">
        <div class="modal-top">
          <h3 class="modal-title">Share Room</h3>
          <button class="modal-close" id="modal-close-btn">√ó</button>
        </div>
        <div class="share-url">
          <span class="share-url-label">Share this URL</span>
          <div id="share-url-value" class="share-url-value"></div>
        </div>
        <div class="qr-code">
          <div id="qr-canvas"></div>
        </div>
        <button class="btn" id="copy-url-btn">üìã Copy URL</button>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <footer class="footer">
      <div class="footer-container">
        <a href="/tos" class="footer-link">Terms of Service</a> |
        <a href="/privacy" class="footer-link">Privacy Policy</a> |
        <a href="/license" class="footer-link">License</a> |
        <a href="https://github.com/axrxvm/synkros" class="footer-link">GitHub</a> |
        <a href="/report" class="footer-link">Report Abuse</a>
      </div>
    </footer>
    </div>

    <script src="/js/error-handler.js" nonce="<%= locals.cspNonce %>"></script>
    <script src="/js/e2ee.js" nonce="<%= locals.cspNonce %>"></script>
    <script src="/js/p2p-crypto.js" nonce="<%= locals.cspNonce %>"></script>
    <script src="/js/p2p-manager.js" nonce="<%= locals.cspNonce %>"></script>
    <script nonce="<%= locals.cspNonce %>">
      // Global state
      let p2pManager = null;
      let currentRoomCode = null;
      let currentRoomPassword = null;
      let currentEncryptionKey = null;
      let receivedFiles = [];

      // DOM Elements
      const setupScreen = document.getElementById('setup-screen');
      const dashboard = document.getElementById('dashboard');
      const createSection = document.getElementById('create-section');
      const joinSection = document.getElementById('join-section');
      const connectBtn = document.getElementById('connect-btn');
      const joinUrlInput = document.getElementById('join-url');
      const joinCodeInput = document.getElementById('join-code');
      const joinKeyInput = document.getElementById('join-key');

      // Auto-parse share URL when pasted
      joinUrlInput.addEventListener('input', (e) => {
        const url = e.target.value.trim();
        if (!url) return;
        
        try {
          // Parse URL hash for room code and encryption key
          let hash = '';
          if (url.includes('#')) {
            hash = url.split('#')[1];
          } else {
            // Maybe user just pasted the hash part
            hash = url;
          }
          
          if (hash.includes(':')) {
            const [roomCode, encKey] = hash.split(':');
            if (roomCode && roomCode.length === 8 && encKey && encKey.length === 64) {
              joinCodeInput.value = roomCode.toUpperCase();
              joinKeyInput.value = encKey;
              currentEncryptionKey = encKey;
              showToast('Share URL parsed successfully!', 'success');
            }
          }
        } catch (error) {
          console.error('URL parse error:', error);
        }
      });

      // Also support pasting directly in code or key fields
      [joinCodeInput, joinKeyInput].forEach(input => {
        input.addEventListener('paste', (e) => {
          setTimeout(() => {
            const value = input.value.trim();
            if (value.includes('#') || value.includes(':')) {
              // Looks like a URL, trigger URL parser
              joinUrlInput.value = value;
              joinUrlInput.dispatchEvent(new Event('input'));
            }
          }, 10);
        });
      });

      // Toggle visibility for password and key fields
      document.querySelectorAll('.toggle-visibility').forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-target');
          const input = document.getElementById(targetId);
          
          if (input.type === 'password') {
            input.type = 'text';
            button.textContent = 'üôà'; // Hide icon
          } else {
            input.type = 'password';
            button.textContent = 'üëÅÔ∏è'; // Show icon
          }
        });
      });
      const uploadZone = document.getElementById('upload-zone');
      const fileInput = document.getElementById('file-input');
      const sendProgress = document.getElementById('send-progress');
      const sendProgressBar = document.getElementById('send-progress-bar');
      const sendProgressLabel = document.getElementById('send-progress-label');
      const receiveProgress = document.getElementById('receive-progress');
      const receiveProgressBar = document.getElementById('receive-progress-bar');
      const receiveProgressLabel = document.getElementById('receive-progress-label');
      const filesEmpty = document.getElementById('files-empty');
      const filesList = document.getElementById('files-list');
      const roomCodeDisplay = document.getElementById('room-code-display');
      const peerCount = document.getElementById('peer-count');
      const toast = document.getElementById('toast');
      const shareModal = document.getElementById('share-modal');

      // Check for share URL in hash on page load
      window.addEventListener('load', () => {
        const urlData = window.p2pEncryption.parseShareURL();
        if (urlData && urlData.roomCode && urlData.encryptionKey) {
          // Auto-fill join form
          document.getElementById('join-code').value = urlData.roomCode;
          document.getElementById('join-key').value = urlData.encryptionKey;
          currentEncryptionKey = urlData.encryptionKey;
          
          // Switch to join mode
          document.querySelector('input[value="join"]').checked = true;
          createSection.classList.add('hidden');
          joinSection.classList.remove('hidden');
          connectBtn.textContent = 'Join Room';
          
          window.p2pEncryption.clearURLHash();
          showToast('üîë Share URL detected! Room details filled automatically.', 'success');
        }
      });

      // Mode switcher
      document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.value === 'create') {
            createSection.classList.remove('hidden');
            joinSection.classList.add('hidden');
            connectBtn.textContent = 'Create Room';
          } else {
            createSection.classList.add('hidden');
            joinSection.classList.remove('hidden');
            connectBtn.textContent = 'Join Room';
          }
        });
      });

      // Connect button
      connectBtn.addEventListener('click', async () => {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        
        if (mode === 'create') {
          const password = document.getElementById('room-password').value.trim();
          await createRoom(password);
        } else {
          const code = document.getElementById('join-code').value.trim().toUpperCase();
          const encryptionKey = document.getElementById('join-key').value.trim();
          const password = document.getElementById('join-password').value.trim();
          
          if (!code || code.length !== 8) {
            showToast('‚ö†Ô∏è Please enter a valid 8-character room code', 'error');
            return;
          }
          
          if (!encryptionKey || encryptionKey.length !== 64) {
            showToast('‚ö†Ô∏è Encryption key is required (64 characters). Use the share URL!', 'error');
            return;
          }
          
          // Set the encryption key before joining
          currentEncryptionKey = encryptionKey;
          
          await joinRoom(code, password);
        }
      });

      // Create room
      async function createRoom(password = '') {
        try {
          connectBtn.disabled = true;
          connectBtn.textContent = 'Creating...';

          const maxPeers = parseInt(document.getElementById('max-peers').value) || 2;

          // Generate encryption key for P2P transfers
          const key = await window.p2pEncryption.generateKey();
          currentEncryptionKey = await window.p2pEncryption.exportKeyToHex(key);

          p2pManager = new P2PManager();
          await p2pManager.init(<%- stunServers %>);
          
          const data = await p2pManager.createRoom(password, maxPeers);

          currentRoomCode = data.roomCode;
          currentRoomPassword = password;
          
          initializeDashboard();
          setupP2PHandlers();
          
          showToast('Room created successfully!', 'success');
        } catch (error) {
          console.error('Create room error:', error);
          showToast(error.message, 'error');
          connectBtn.disabled = false;
          connectBtn.textContent = 'Create Room';
        }
      }

      // Join room
      async function joinRoom(code, password = '') {
        try {
          connectBtn.disabled = true;
          connectBtn.textContent = 'Joining...';

          currentRoomCode = code;
          currentRoomPassword = password;
          
          p2pManager = new P2PManager();
          await p2pManager.init(<%- stunServers %>);
          await p2pManager.joinRoom(code, password);
          
          initializeDashboard();
          setupP2PHandlers();
          
          showToast('Joined room successfully!', 'success');
        } catch (error) {
          console.error('Join room error:', error);
          showToast(error.message, 'error');
          connectBtn.disabled = false;
          connectBtn.textContent = 'Join Room';
          currentEncryptionKey = null; // Clear on error
        }
      }

      // Initialize dashboard
      function initializeDashboard() {
        setupScreen.classList.add('hidden');
        dashboard.classList.remove('hidden');
        roomCodeDisplay.textContent = currentRoomCode;
      }

      // Setup P2P handlers
      function setupP2PHandlers() {
        p2pManager.on('peer-joined', (peerId) => {
          updatePeerCount();
          showToast('Peer connected', 'success');
        });

        p2pManager.on('peer-left', (peerId) => {
          updatePeerCount();
          showToast('Peer disconnected', 'error');
        });

        p2pManager.on('file-received', async (fileData) => {
          try {
            if (!currentEncryptionKey) {
              showToast('üîí Cannot decrypt: Missing encryption key from share URL', 'error');
              console.error('No encryption key available.');
              return;
            }
            
            // Show receive progress
            receiveProgress.classList.remove('hidden');
            receiveProgressBar.style.width = '50%';
            receiveProgressLabel.textContent = 'File received! Starting decryption...';
            showToast(`üì• Received ${fileData.name}, decrypting...`, 'info');
            
            const key = await window.p2pEncryption.importKeyFromHex(currentEncryptionKey);
            const decryptedBlob = await window.p2pEncryption.decryptReceivedFile(
              fileData.data,
              key,
              (progress) => {
                const decryptProgress = 50 + (progress * 0.5);
                receiveProgressBar.style.width = decryptProgress + '%';
                receiveProgressLabel.textContent = `Decrypting: ${Math.round(progress)}%`;
              }
            );

            receiveProgressBar.style.width = '100%';
            receiveProgressLabel.textContent = 'Decryption complete!';

            receivedFiles.push({
              name: fileData.name,
              size: fileData.size,
              data: decryptedBlob,
              peerId: fileData.peerId
            });
            
            renderFilesList();
            showToast(`‚úÖ ${fileData.name} ready!`, 'success');
            
            // Hide progress after 2 seconds
            setTimeout(() => {
              receiveProgress.classList.add('hidden');
              receiveProgressBar.style.width = '0%';
            }, 2000);
          } catch (error) {
            console.error('File decryption error:', error);
            receiveProgress.classList.add('hidden');
            showToast('Failed to decrypt received file: ' + error.message, 'error');
          }
        });

        p2pManager.on('transfer-progress', (data) => {
          if (data.direction === 'send') {
            uploadZone.classList.add('sending');
            sendProgress.classList.remove('hidden');
            sendProgressBar.style.width = data.progress + '%';
            sendProgressLabel.textContent = `Sending ${data.fileName}: ${data.progress}%`;
            
            if (data.progress === 100) {
              setTimeout(() => {
                uploadZone.classList.remove('sending');
                sendProgress.classList.add('hidden');
                sendProgressBar.style.width = '0%';
              }, 2000);
            }
          } else if (data.direction === 'receive') {
            receiveProgress.classList.remove('hidden');
            receiveProgressBar.style.width = (data.progress * 0.5) + '%';
            receiveProgressLabel.textContent = `Receiving ${data.fileName}: ${data.progress}%`;
            showToast(`üì• Receiving ${data.fileName}...`, 'info');
          }
        });
      }

      // Update peer count
      function updatePeerCount() {
        const count = p2pManager ? p2pManager.getConnectedPeers().length : 0;
        peerCount.textContent = count === 1 ? '1 peer' : `${count} peers`;
      }

      // Upload zone
      uploadZone.addEventListener('click', () => fileInput.click());
      
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
      });

      uploadZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        await sendFiles(files);
      });

      fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        await sendFiles(files);
        fileInput.value = '';
      });

      // Send files
      async function sendFiles(files) {
        if (!p2pManager || files.length === 0) return;
        
        if (p2pManager.dataChannels.size === 0) {
          showToast('No peers connected. Wait for others to join.', 'error');
          return;
        }
        
        if (!currentEncryptionKey) {
          showToast('üîí Cannot encrypt: Missing encryption key', 'error');
          console.error('No encryption key available.');
          return;
        }
        
        try {
          for (const file of files) {
            uploadZone.classList.add('sending');
            sendProgress.classList.remove('hidden');
            sendProgressBar.style.width = '0%';
            sendProgressLabel.textContent = 'Encrypting file...';

            // Encrypt file using P2P encryption
            const encryptedBlob = await window.p2pEncryption.encryptFileForP2P(
              file,
              currentEncryptionKey,
              (progress) => {
                sendProgressBar.style.width = (progress * 0.5) + '%';
                sendProgressLabel.textContent = `Encrypting: ${Math.round(progress * 0.5)}%`;
              }
            );

            sendProgressBar.style.width = '50%';
            sendProgressLabel.textContent = 'Broadcasting to peers...';

            // Broadcast encrypted file to all peers
            await p2pManager.broadcastFile(file, encryptedBlob, {
              name: file.name,
              size: encryptedBlob.size,
              originalSize: file.size
            });

            sendProgressBar.style.width = '100%';
            sendProgressLabel.textContent = 'Sent successfully!';
            
            setTimeout(() => {
              uploadZone.classList.remove('sending');
              sendProgress.classList.add('hidden');
              sendProgressBar.style.width = '0%';
            }, 2000);
            
            showToast(`Sent: ${file.name}`, 'success');
          }
        } catch (error) {
          console.error('Send file error:', error);
          uploadZone.classList.remove('sending');
          showToast('Failed to send file: ' + error.message, 'error');
          sendProgress.classList.add('hidden');
        }
      }

      // Render files list
      function renderFilesList() {
        if (receivedFiles.length === 0) {
          filesEmpty.classList.remove('hidden');
          filesList.classList.add('hidden');
          return;
        }

        filesEmpty.classList.add('hidden');
        filesList.classList.remove('hidden');
        
        filesList.innerHTML = receivedFiles.map((file, index) => `
          <div class="file-item">
            <div class="file-icon">üìÑ</div>
            <div class="file-info">
              <div class="file-name">${escapeHtml(file.name)}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
            <button class="btn btn-sm download-file-btn" data-index="${index}">üíæ Save</button>
          </div>
        `).join('');
      }

      // Event delegation for download buttons
      filesList.addEventListener('click', (e) => {
        if (e.target.classList.contains('download-file-btn')) {
          const index = parseInt(e.target.getAttribute('data-index'));
          downloadFile(index);
        }
      });

      // Download file
      function downloadFile(index) {
        const file = receivedFiles[index];
        const blob = new Blob([file.data], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        a.click();
        URL.revokeObjectURL(url);
        showToast(`Downloaded: ${file.name}`, 'success');
      }

      // Share button
      document.getElementById('share-btn').addEventListener('click', async () => {
        const shareUrl = window.p2pEncryption.createShareURL(currentRoomCode, currentEncryptionKey);
        document.getElementById('share-url-value').textContent = shareUrl;
        
        // Generate QR code via API (using GET endpoint for simplicity)
        const qrContainer = document.getElementById('qr-canvas');
        const encodedUrl = encodeURIComponent(shareUrl);
        qrContainer.innerHTML = `<img src="/api/qr?url=${encodedUrl}&size=200&color=%234c8bf4&bgColor=%23202124" alt="QR Code" style="display: block; margin: 0 auto; border-radius: 8px;" onerror="this.parentElement.innerHTML='<div style=\\'padding: 20px; color: #e53e3e;\\'>Failed to load QR code</div>'">`;
        
        shareModal.classList.add('active');
      });

      // Close share modal
      function closeShareModal() {
        shareModal.classList.remove('active');
      }

      document.getElementById('modal-close-btn').addEventListener('click', closeShareModal);

      // Copy share URL
      function copyShareUrl() {
        const url = document.getElementById('share-url-value').textContent;
        navigator.clipboard.writeText(url);
        showToast('URL copied to clipboard!', 'success');
      }

      document.getElementById('copy-url-btn').addEventListener('click', copyShareUrl);

      // Leave room
      document.getElementById('leave-btn').addEventListener('click', async () => {
        if (confirm('Are you sure you want to leave this room?')) {
          if (p2pManager) {
            await p2pManager.leaveRoom();
          }
          location.reload();
        }
      });

      // Toast notification
      function showToast(message, type = 'info') {
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // Utilities
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // URL parsing is handled by the 'load' event listener above using parseShareURL()

      // Close modal on backdrop click
      shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
          closeShareModal();
        }
      });
    </script>
  </body>
</html>
